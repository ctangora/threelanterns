{% extends "base.html" %}
{% block content %}
<h2>{{ title }}</h2>
{% if error %}
<p><strong>Error:</strong> {{ error }}</p>
{% endif %}
<p>Total in queue: {{ total }}</p>
<p>Showing page {{ page }} (page size {{ page_size }}) with {{ items|length }} item(s).</p>
<form method="get" action="{{ base_path }}" class="card">
  <label>State
    <select name="state">
      <option value="proposed" {% if state == "proposed" %}selected{% endif %}>proposed</option>
      <option value="approved" {% if state == "approved" %}selected{% endif %}>approved</option>
      <option value="rejected" {% if state == "rejected" %}selected{% endif %}>rejected</option>
      <option value="needs_revision" {% if state == "needs_revision" %}selected{% endif %}>needs_revision</option>
    </select>
  </label>
  <label>Source ID (passage queue only)
    <input type="text" name="source_id" value="{{ source_id or '' }}" />
  </label>
  {% if kind == "passage" %}
  <label>Needs reprocess
    <select name="needs_reprocess">
      <option value="" {% if needs_reprocess is none %}selected{% endif %}>(any)</option>
      <option value="true" {% if needs_reprocess is sameas true %}selected{% endif %}>true</option>
      <option value="false" {% if needs_reprocess is sameas false %}selected{% endif %}>false</option>
    </select>
  </label>
  <fieldset class="card">
    <legend>Quality</legend>
    <label>Confidence (min)
      <input type="number" min="0" max="1" step="0.01" name="min_confidence" value="{{ min_confidence if min_confidence is not none else '' }}" />
    </label>
    <label>Confidence (max)
      <input type="number" min="0" max="1" step="0.01" name="max_confidence" value="{{ max_confidence if max_confidence is not none else '' }}" />
    </label>
    <label>Untranslated ratio (min)
      <input type="number" min="0" max="1" step="0.01" name="min_untranslated_ratio" value="{{ min_untranslated_ratio if min_untranslated_ratio is not none else '' }}" />
    </label>
    <label>Untranslated ratio (max)
      <input type="number" min="0" max="1" step="0.01" name="max_untranslated_ratio" value="{{ max_untranslated_ratio if max_untranslated_ratio is not none else '' }}" />
    </label>
    <label>Usability score (min)
      <input type="number" min="0" max="1" step="0.01" name="min_usability" value="{{ min_usability if min_usability is not none else '' }}" />
    </label>
    <label>Usability score (max)
      <input type="number" min="0" max="1" step="0.01" name="max_usability" value="{{ max_usability if max_usability is not none else '' }}" />
    </label>
    <label>Relevance score (min)
      <input type="number" min="0" max="1" step="0.01" name="min_relevance" value="{{ min_relevance if min_relevance is not none else '' }}" />
    </label>
    <label>Relevance score (max)
      <input type="number" min="0" max="1" step="0.01" name="max_relevance" value="{{ max_relevance if max_relevance is not none else '' }}" />
    </label>
  </fieldset>
  <label>Detected language
    <input type="text" name="detected_language" value="{{ detected_language or '' }}" placeholder="eng, Old English, lat..." />
  </label>
  <label>Relevance state
    <select name="relevance_state">
      <option value="" {% if relevance_state is none or relevance_state == "" %}selected{% endif %}>(any)</option>
      <option value="accepted" {% if relevance_state == "accepted" %}selected{% endif %}>accepted</option>
      <option value="borderline" {% if relevance_state == "borderline" %}selected{% endif %}>borderline</option>
      <option value="filtered" {% if relevance_state == "filtered" %}selected{% endif %}>filtered</option>
    </select>
  </label>
  <label>Include filtered passages
    <select name="include_filtered">
      <option value="false" {% if include_filtered is not sameas true %}selected{% endif %}>false</option>
      <option value="true" {% if include_filtered is sameas true %}selected{% endif %}>true</option>
    </select>
  </label>
  {% endif %}
  {% if kind != "passage" %}
  <label>Confidence (min)
    <input type="number" min="0" max="1" step="0.01" name="min_confidence" value="{{ min_confidence if min_confidence is not none else '' }}" />
  </label>
  <label>Confidence (max)
    <input type="number" min="0" max="1" step="0.01" name="max_confidence" value="{{ max_confidence if max_confidence is not none else '' }}" />
  </label>
  {% endif %}
  <label>Sort by
    <select name="sort_by">
      <option value="created_at" {% if sort_by == "created_at" %}selected{% endif %}>created_at</option>
      <option value="confidence" {% if sort_by == "confidence" %}selected{% endif %}>confidence</option>
    </select>
  </label>
  <label>Sort direction
    <select name="sort_dir">
      <option value="asc" {% if sort_dir == "asc" %}selected{% endif %}>asc</option>
      <option value="desc" {% if sort_dir == "desc" %}selected{% endif %}>desc</option>
    </select>
  </label>
  <label>Page size
    <input type="number" min="1" max="200" name="page_size" value="{{ page_size }}" />
  </label>
  <button type="submit">Apply Filters</button>
</form>
<p>
  {% if has_prev %}
  <a href="{{ base_path }}?{{ prev_query }}">Previous</a>
  {% endif %}
  {% if has_prev and has_next %} | {% endif %}
  {% if has_next %}
  <a href="{{ base_path }}?{{ next_query }}">Next</a>
  {% endif %}
</p>
<form id="bulk-review-form" method="post" action="/review/{{ kind }}/bulk" class="card">
  <label>Bulk decision
    <select name="decision">
      <option value="approve">approve</option>
      <option value="reject">reject</option>
      <option value="needs_revision">needs_revision</option>
    </select>
  </label>
  <label>Bulk notes
    <input name="notes" type="text" placeholder="Required for reject/needs_revision" />
  </label>
  <button type="submit">Submit Bulk Review</button>
</form>
{% for item in items %}
<section class="card">
  <h3><a href="/records/{{ item.object_id }}">{{ item.object_id }}</a></h3>
  {% if kind == "passage" %}
  <p>
    Quality:
    <strong>{{ item.translation_status }}</strong>
    | ratio={{ item.untranslated_ratio }}
    | language={{ item.detected_language_label or item.detected_language_code or "und" }}
    | needs_reprocess={{ item.needs_reprocess }}
    | usability={{ item.usability_score }}
    | relevance={{ item.relevance_score }}
    | relevance_state={{ item.relevance_state }}
  </p>
  {% endif %}
  <label><input type="checkbox" form="bulk-review-form" name="object_ids" value="{{ item.object_id }}" /> Select for bulk</label>
  <pre>{{ item.payload_pretty }}</pre>
  {% if kind == "passage" %}
  <form method="post" action="/review/passages/{{ item.object_id }}/reprocess">
    <label>Reprocess reason code
      <select name="reason_code">
        {% for reason_code, reason_label in reprocess_reason_options %}
        <option value="{{ reason_code }}">{{ reason_label }} ({{ reason_code }})</option>
        {% endfor %}
      </select>
    </label>
    <label>Reprocess reason note
      <input name="reason_note" type="text" placeholder="Optional context for this reprocess request" />
    </label>
    <button type="submit">Queue Reprocess</button>
  </form>
  {% endif %}
  <form method="post" action="/review/{{ kind }}/{{ item.object_id }}">
    <label>Decision
      <select name="decision">
        <option value="approve">approve</option>
        <option value="reject">reject</option>
        <option value="needs_revision">needs_revision</option>
      </select>
    </label>
    <label>Notes
      <input name="notes" type="text" placeholder="Required for reject/needs_revision" />
    </label>
    <button type="submit">Submit Review</button>
  </form>
</section>
{% endfor %}
{% endblock %}

{% extends "base.html" %}
{% block content %}
<h2>Passage Reprocess Jobs</h2>
{% if error %}
<p><strong>Error:</strong> {{ error }}</p>
{% endif %}
<p>Total jobs: {{ total }}</p>
<p>Showing page {{ page }} (page size {{ page_size }}) with {{ items|length }} item(s).</p>
<form method="get" action="/review/reprocess-jobs">
  <input type="hidden" name="page" value="{{ page }}" />
  <input type="hidden" name="page_size" value="{{ page_size }}" />
  <input type="hidden" name="status" value="{{ status }}" />
  <input type="hidden" name="trigger_mode" value="{{ trigger_mode }}" />
  <input type="hidden" name="reason_code" value="{{ reason_code }}" />
  <input type="hidden" name="passage_id" value="{{ passage_id }}" />
  <input type="hidden" name="auto_refresh" value="{{ auto_refresh if auto_refresh_enabled else 'off' }}" />
  <button type="submit">Refresh Now</button>
</form>
<form method="get" action="/review/reprocess-jobs" class="card">
  <label>Status
    <select name="status">
      <option value="" {% if status == "" %}selected{% endif %}>(any)</option>
      <option value="pending" {% if status == "pending" %}selected{% endif %}>pending</option>
      <option value="running" {% if status == "running" %}selected{% endif %}>running</option>
      <option value="completed" {% if status == "completed" %}selected{% endif %}>completed</option>
      <option value="failed" {% if status == "failed" %}selected{% endif %}>failed</option>
      <option value="dead_letter" {% if status == "dead_letter" %}selected{% endif %}>dead_letter</option>
    </select>
  </label>
  <label>Trigger mode
    <select name="trigger_mode">
      <option value="" {% if trigger_mode == "" %}selected{% endif %}>(any)</option>
      <option value="manual" {% if trigger_mode == "manual" %}selected{% endif %}>manual</option>
      <option value="auto_threshold" {% if trigger_mode == "auto_threshold" %}selected{% endif %}>auto_threshold</option>
    </select>
  </label>
  <label>Reason code
    <select name="reason_code">
      <option value="" {% if reason_code == "" %}selected{% endif %}>(any)</option>
      {% for code, label in reprocess_reason_options %}
      <option value="{{ code }}" {% if reason_code == code %}selected{% endif %}>{{ label }} ({{ code }})</option>
      {% endfor %}
    </select>
  </label>
  <label>Passage ID
    <input type="text" name="passage_id" value="{{ passage_id }}" />
  </label>
  <label>Auto refresh
    <select name="auto_refresh">
      <option value="off" {% if not auto_refresh_enabled %}selected{% endif %}>off</option>
      <option value="10" {% if auto_refresh == 10 %}selected{% endif %}>10s</option>
      <option value="30" {% if auto_refresh == 30 %}selected{% endif %}>30s</option>
      <option value="60" {% if auto_refresh == 60 %}selected{% endif %}>60s</option>
    </select>
  </label>
  <label>Page size
    <input type="number" min="1" max="200" name="page_size" value="{{ page_size }}" />
  </label>
  <button type="submit">Apply Filters</button>
</form>
<p>
  {% if has_prev %}
  <a href="/review/reprocess-jobs?{{ prev_query }}">Previous</a>
  {% endif %}
  {% if has_prev and has_next %} | {% endif %}
  {% if has_next %}
  <a href="/review/reprocess-jobs?{{ next_query }}">Next</a>
  {% endif %}
</p>
{% for item in items %}
<section class="card">
  <h3><a href="/records/{{ item.reprocess_job_id }}">{{ item.reprocess_job_id }}</a></h3>
  <p>Passage: <a href="/records/{{ item.passage_id }}">{{ item.passage_id }}</a></p>
  <p>Status: {{ item.status }} | Trigger: {{ item.trigger_mode }} | Attempts: {{ item.attempt_count }}/{{ item.max_attempts }}</p>
  <p>Reason code: {{ item.trigger_reason_code }} | Reason note: {{ item.trigger_reason_note or item.trigger_reason }}</p>
  <p>Used PDF cross-ref: {{ item.used_pdf_crossref }} | Used external reference: {{ item.used_external_reference }}</p>
  {% if item.last_error %}
  <pre>{{ item.last_error }}</pre>
  {% endif %}
</section>
{% endfor %}
{% if auto_refresh_enabled %}
<script>
  window.setTimeout(() => {
    window.location.reload();
  }, {{ auto_refresh * 1000 }});
</script>
{% endif %}
{% endblock %}
